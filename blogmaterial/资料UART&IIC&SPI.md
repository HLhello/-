# UART & IIC & SPI

背景

- 现今，在低端数字通信应用领域，我们随处可见IIC (Inter-Integrated Circuit) 和 SPI (Serial Peripheral Interface)的身影。原因是这两种通信协议非常适合近距离低速芯片间通信。Philips（for IIC）和Motorola（for SPI） 出于不同背景和市场需求制定了这两种标准通信协议。

我们来看看比特速递公司(bit-delivering company,PDC)是如何输送8bit货物的。

现在有一辆拉载着8bit数据的快递货车由公司(PC端/嵌入式端/外设设备)发出。携带着齐全证件(起始位、奇偶位、停止位)，愉快地上路了。

仪表盘上显示着稳定地9600bps，表示一秒可送9600bit(包括证件在内)，经过“长途跋涉”，终于到达终点站(另一个PC/嵌入式/外设设备)。

首先，货车司机出示货运单(起始位)表示“您要的货到了”，这时，终点站验货员要对其进行验货。可悲的是，验货员是个瞎子，他可不能一个一个地数。幸好，早在发货之前双方已经约定，使用中华传统技艺——接头暗号(奇偶位)——进行验货。他们的规则是：发货公司表示，今天的暗号是天王盖地虎(奇校检)，那么货运单上写的就是宝塔镇河妖(哎对上了);而公司要是说，今天的暗号是今朝有酒今朝醉(偶校检)，货运单上还是宝塔镇河妖，那就对不上。因为tomorrow is an other day才是正解。

瞎子验货员一看货运单，哎一拍即合，验货员笑纳了8bit的数据。可别急，还得检查是否漏货，万一少了一两个bit，那就乱码了。一看货运单上的标示(停止位)，瞎子哥终于放心地签收了，然后摆摆手，这时货车靠边(空闲位)腾出空位。瞎子哥等待下一辆货车。

发现没
​       第一：所有证件(起始位，停止位，奇偶位)都由比特速递公司(即发送端)提供。
​       第二：货物(8bit数据)只能一车一车有序接收或者从公司发送。
第三：空闲位需要瞎子验货员摆手示意。也就是说，空闲位不属于速递公司的必备证件，终点站在收货后，自己腾出空位来，等待下一辆货车。


实际上，在硬件逻辑电路中实现发送端给的货车装货、配备证件和运货单需要严格按照图1的格式，数据流(包括起始位、停止位和校检位)必须按照按照波特率规定的速度一bit一bit地输送出去。而接受端，需要严格按照波特率规定的速度，在每一个bit的中间位置处采集送来的信号(为了数据的顺利采集，有时将每一个bit分成数份，再在每小份的中间位置采集)。



​    常见比特率——9600bps 19200bps 38400bps 57600bps 115200bps



UART协议格式

信号线上空闲的时候为高电平，当出现下跳到低电平的时候表示数据的起始位，接着是先发送低位（LSB）后发送高位（MSB）的数据流，尾部可加奇偶校验位，最后加停止位，停止位长度可以定义。本例实现无奇偶校验位，1bit停止位，波特率9600~115200可改变。



![img](https://pic2.zhimg.com/v2-e346b48a1e446d1f17c87daf844d4959_b.jpg)



多帧发送结构如下：



![img](https://pic2.zhimg.com/v2-df58049d703fc5171014412118dc6241_b.jpg)



代码实现解释