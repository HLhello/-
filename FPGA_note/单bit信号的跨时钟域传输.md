## 亚稳态

1. 亚稳态的概念和原理

   1. 亚稳态是指处触发器无法在某个规定时间段内达到一个可确认的状态
   2. 当一个触发器进入亚稳态时，既无法确定该单元的输出电平，也无法预测何时输出才能稳定在某个正确的电平上
   3. 在这个期间，触发器输出一些中间级电平，或者可能处于震荡状态，并且这种无用的输出电平可以演信号通道上的各个触发器级联式的传播下去 

2. 故障间隔平均时间MTBF

   - 公式： $MTBF = (e^{t_{MET}/C_2})/(C_1f_{clk}f_{data})$
   - $t_{MET} $ 寄存器从时钟上升沿触发后的时序余量时间
     - 如果要提升$t_{MET}$ ，需要降低$t_{data}$ 
     - $t_{data}$指两个寄存器间的逻辑延迟以及走线延迟之和，最大程度的减小它，只能是在两个寄存器之间不添加任何逻辑
   - $f_{clk}$ 接收时钟域的时钟频率
   - $f_{data}$ 数据的变化频率
   - $c_1,c_2$ 与器件有关的参数
   - 公式中看出亚稳态不可能从根本上消除，但可以通过采取一定的措施使其对电路的影响降低
   - 为避免上述亚稳态问题，即参数MTBF尽可能的大，通常采用的方法是双锁存器法，即在一个信号进入另一个时钟域前，将该信号用两个锁存器连续锁存两次，最后得到的采样结果就可以消除亚稳态问题
   - 一个信号在过渡到另一个时钟域时，如果仅仅在一个触发器将其锁存，那么$b_{clk}$进行采样的结果可能是亚稳态，这也是信号在跨时钟域应该注意的问题

3. 消除亚稳态的方法 —— 即在不同时时钟域之间如何安全的传递信号

   1. 双锁存器法（虽然叫锁存器，实际是两个触发器），双锁存器同

      ![双锁存器同步器](单bit信号的跨时钟域传输.assets/双锁存器同步.png)

      - ==常用于慢时钟域转换到快时钟域==

      - 优点
        - 结构简单，易于实现，面积消耗小
      - 缺点
        1. 增加了两个时钟周期，对时钟性能有消极影响
        2. 当快时钟域转到慢时钟域时，易造成慢时钟采样丢失，还没来得及采样，数据就变化了

   2. 使用几级DFF进行异步信号同步最合适

      1. 两级寄存器已经可以将亚稳态出现的概率降的足够低，因此二级就可以了

   3. 寄存器同步法是否可以消除亚稳态

      1. 对于典型的0.25um工艺的asic器件，MTBF = 2.01（day），也就是说每隔两天便可能出现一次亚稳态，同样参数，在使用双寄存器法后，这个时间可以延迟到$10^9$年
      2. 只是降低了亚稳态的概率，并不能消除亚稳态

## 竞争冒险

1. 竞争与冒险定义
   1. 竞争(Competition): 在组合逻辑电路中，某个输入变量通过两条或两条以上的途径传到输出端，由于每条途径延迟时间不同，到达输出门的时间就有先有后，这种现象称为竞争。
   2. 冒险(risk)：多路信号的电平值发生变化时，在信号变化的瞬间，组合逻辑的输出有先后顺序，并不是同时变化，往往会出现一些不正确的尖峰信号，这些尖峰信号称为"毛刺"。如果一个组合逻辑电路中有"毛刺"出现，就说明该电路存在冒险。
2. 原因
   - 竞争冒险(Competition risk)产生原因：由于延迟时间的存在，当一个输入信号经过多条路径传送后又重新会合到某个门上，由于不同路径上门的级数不同，或者门电路延迟时间的差异，导致到达会合点的时间有先有后，从而产生瞬间的错误输出。
3. 解决办法
   1. 从根源上解决问题：竞争和冒险产生的根本原因是由于，同一时刻可能有多个信号发生变化。
      1. 保证同一时刻只允许单个输入变量发生变化，即可避免产生毛刺。比如对数据进行格雷码编码，即可以解决这个问题。
      2. 通过时钟对输出结果进行采样，当输出保持稳定时再将结果输出给后续模块。
   2. 避免竞争冒险引起的毛刺对后续电路造成影响
      1. 在毛刺进入到下一个模块之前，通过滤波电路将毛刺滤除。毛刺一般是非常窄的脉冲，可以在输出端接一个几百微法的电容将其滤出掉。
      2. 在下一级模块中，对输入信号进行采样，当信号保持稳定后，再进行操作。

## 跨时钟域的传输可大致分为以下两大类：

**单比特：**当单比特信号跨时钟域时，有两种情况一种是由快时钟域到慢时钟域，我们可以采用脉冲展宽法、反馈信号法、绳结法等；另一种是慢速时钟域到快速时钟域，我们直接采用两级触发器来同步

**多比特：**多比特信号（数据流或地址总线）跨时钟域时可以分两种情况，即慢到快和快到慢的情况，这里我们不分开列举，仅在括号中备注，其中有：DMUX法（慢到快）、保持寄存器加握手信号法（两种情况均可）、标志信号同步法（两种情况均可）、格雷码（数据需连续，两种情况均可）、异步FIFO（硬核FIFO和格雷码FIFO[RAM+格雷码]，两种情况均可）、RAM（两种情况均可）等。



## 单bit信号的跨时钟域传输

1. 单bit信号跨时钟域如何传输

   1. 边沿检测同步电路（慢到快）

      ![边沿检测同步器](单bit信号的跨时钟域传输.assets/单bit信号边沿检测.png)

      1. 这种方法通常应用在慢速时钟向快速时钟传递过程中，可以检测输入信号的上升沿，也可以检测她的下降沿 
      2. 使用条件
         1. 输入数据的宽度必须必一个接受时钟周期加上一个同步触发器的hold时间要长，最安全的就是两个同步周期宽度
         2. 慢时钟域的脉冲保持到被快时钟的同步器拿到 

   2. 脉冲同步基本功能（快到慢）

      1. 从快时钟域去除一个单时钟宽度脉冲，然后在慢时钟域中建立另一个单时钟宽度的脉冲

   3. 结绳法

      ![结绳法]()

      1. 信号从快时钟到慢时钟过渡时，慢时钟将可能无法对变化太快的信号实现正确采样
      2. 双锁存器，脉冲，边沿这三种方法对两个时钟之间的关系要求很严格，结绳法使用任何时钟域的过渡
      3. 原理
         1. 将快时钟域信号的脉冲周期延长，等到慢时钟同步采样后再解绳，还原为原来的脉冲宽度 
      4. 结绳法优缺点
         1. 可以实现快时钟想慢时钟过渡的问题，使用范围广
         2. 结绳法实现比较复杂，特别是效率不高，在对设计性能要求较高的场合慎用

   4. 慢到快如何实现

      1. 双锁存器法
      2. 边沿检测同步电路

   5. 快到慢如何实现

      1. 脉冲同步器（有条件的）
      2. 结绳法（较为复杂）
      
   6. 采样中，快到慢，与，慢到快，在考虑问题时有什么区别，为什么不能用慢时钟直接采样快时钟域的信号

      1. 慢到快只要考虑亚稳态问题
      2. 快到慢处了亚稳态问题外，还需要考虑慢时钟的采样速率问题，因为根据采样定理采样频率低于信号最高频率的两倍的时候，是无法完整采样的

总结：单比特信号跨时钟域是我一直没有想明白的一个问题

​		跨时钟域处理是 FPGA 设计中经常遇到的问题，而如何处理好跨时钟域间的数据，可以说是每个FPGA初学者的必修课。这里主要介绍3 种跨时钟域处理的方法，这3 种方法可以说是FPGA 界最常用也最实用的方法，这三种方法包含了单bit和多bit数据的跨时钟域处理，学会这 3 招之后，对于FPGA 相关的跨时钟域数据处理便可以手到擒来。其中之一就是直接使用异步ram，异步fifo异步ram，异步fifo，处理多 bit 数据的跨时钟域，一般采用异步双口 RAM。当然，在能使用异步双口RAM来处理跨时钟域的场景中，也可以使用异步FIFO来达到同样的目的

我自己常用的两个跨时钟处理方法：1)打两拍；2)格雷码转换；

1. 打两拍（单比特）
   - 打两拍实际的电路图就是双锁存器电平同步，常用于处理单比特电路跨时钟域
   - 应该很多人都会问，为什么是打两拍呢，打一拍、打三拍行不行呢？根据MTBF公式，多了对效果提升不大，反而增加时延
2. 格雷码转换（多比特）
   - 格雷码将多比特转换为单比特，即在连续变化的数据里，可以将需要跨时钟域的数据转换为格雷码，这样每次只变换1bit将问题转到打两拍上
   - 使用各类跨时钟域是，要注意跨时钟域处理有时将时钟设置为set false path，但使用格雷码后进行时钟约束时要注意约束set_max_delay 不要超过两个时钟域中最小的时钟周期



